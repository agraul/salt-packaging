From 1c0e9772189bfe1f33fc215ce52d0c3d7df02525 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Pablo=20Su=C3=A1rez=20Hern=C3=A1ndez?=
 <psuarezhernandez@suse.com>
Date: Thu, 26 Jul 2018 16:42:10 +0100
Subject: [PATCH] Avoid incomprehensive message if crashes

Check dmidecoder executable on each call to avoid crashing

Fix pylint issues
---
 salt/modules/smbios.py | 22 +++++++++++++++++-----
 1 file changed, 17 insertions(+), 5 deletions(-)

diff --git a/salt/modules/smbios.py b/salt/modules/smbios.py
index c0727b93a5..6da788a34c 100644
--- a/salt/modules/smbios.py
+++ b/salt/modules/smbios.py
@@ -19,6 +19,7 @@ import re
 
 # Import salt libs
 import salt.utils.path
+from salt.exceptions import CommandExecutionError
 
 # Solve the Chicken and egg problem where grains need to run before any
 # of the modules are loaded and are generally available for any usage.
@@ -30,12 +31,21 @@ from salt.ext.six.moves import zip  # pylint: disable=import-error,redefined-bui
 log = logging.getLogger(__name__)
 
 
+def _refresh_dmidecoder():
+    global DMIDECODER
+    DMIDECODER = salt.utils.path.which_bin(['dmidecode', 'smbios'])
+
+
 def __virtual__():
     '''
     Only work when dmidecode is installed.
     '''
-    return (bool(salt.utils.path.which_bin(['dmidecode', 'smbios'])),
-            'The smbios execution module failed to load: neither dmidecode nor smbios in the path.')
+    _refresh_dmidecoder()
+    if DMIDECODER is None:
+        log.debug('SMBIOS: neither dmidecode nor smbios found!')
+        return (False, 'The smbios execution module failed to load: neither dmidecode nor smbios in the path.')
+    else:
+        return True
 
 
 def get(string, clean=True):
@@ -317,10 +327,12 @@ def _dmidecoder(args=None):
     '''
     Call DMIdecode
     '''
-    dmidecoder = salt.utils.path.which_bin(['dmidecode', 'smbios'])
+    _refresh_dmidecoder()
+    if DMIDECODER is None:
+        raise CommandExecutionError('SMBIOS: neither dmidecode nor smbios found!')
 
-    if not args:
-        out = salt.modules.cmdmod._run_quiet(dmidecoder)
+    if args is None:
+        return salt.modules.cmdmod._run_quiet(DMIDECODER)
     else:
         out = salt.modules.cmdmod._run_quiet('{0} {1}'.format(dmidecoder, args))
 
-- 
2.17.1


