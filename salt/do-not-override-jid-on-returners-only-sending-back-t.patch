From 605fcf647b7da8783e61be2ef2d4d447490ca4fc Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Pablo=20Su=C3=A1rez=20Hern=C3=A1ndez?=
 <psuarezhernandez@suse.com>
Date: Fri, 4 May 2018 09:34:13 +0100
Subject: [PATCH] Do not override jid on returners, only sending back to
 master (bsc#1092373)

---
 salt/utils/schedule.py | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/salt/utils/schedule.py b/salt/utils/schedule.py
index d902c6814e..9ab678b911 100644
--- a/salt/utils/schedule.py
+++ b/salt/utils/schedule.py
@@ -894,10 +894,13 @@ class Schedule(object):
                     else:
                         # Send back to master so the job is included in the job list
                         mret = ret.copy()
-                        mret['jid'] = 'req'
-                        if data.get('return_job') == 'nocache':
-                            # overwrite 'req' to signal to master that this job shouldn't be stored
-                            mret['jid'] = 'nocache'
+                        # No returners defined, so we're only sending back to the master
+                        if not data_returner and not self.schedule_returner:
+                            mret['jid'] = 'req'
+                            if data.get('return_job') == 'nocache':
+                                # overwrite 'req' to signal to master that
+                                # this job shouldn't be stored
+                                mret['jid'] = 'nocache'
                         event = salt.utils.event.get_event('minion', opts=self.opts, listen=False)
                         load = {'cmd': '_return', 'id': self.opts['id']}
                         for key, value in six.iteritems(mret):
-- 
2.15.1


