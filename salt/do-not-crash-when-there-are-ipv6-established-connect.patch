From 3a7c4c58a1f1642dfbff1f500e5d0164a769fcc2 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Pablo=20Su=C3=A1rez=20Hern=C3=A1ndez?=
 <psuarezhernandez@suse.com>
Date: Tue, 7 May 2019 15:33:51 +0100
Subject: [PATCH] Do not crash when there are IPv6 established
 connections (bsc#1130784)

Add unit test for '_netlink_tool_remote_on'
---
 salt/utils/network.py | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/salt/utils/network.py b/salt/utils/network.py
index 2ae2e213b7..74536cc143 100644
--- a/salt/utils/network.py
+++ b/salt/utils/network.py
@@ -1444,6 +1444,10 @@ def _netlink_tool_remote_on(port, which_end):
         chunks = line.split()
         remote_host, remote_port = chunks[4].rsplit(':', 1)
 
+        if which_end == 'remote_port' and int(remote_port) != port:
+            continue
+        if which_end == 'local_port' and int(local_port) != port:
+            continue
         remotes.add(remote_host.strip("[]"))
 
     if valid is False:
-- 
2.16.4


