From 6065d16e0c12498474b611d0aefd1edc4901b935 Mon Sep 17 00:00:00 2001
From: Victor Zhestkov <35733135+vzhestkov@users.noreply.github.com>
Date: Thu, 18 Feb 2021 14:50:37 +0300
Subject: [PATCH] Add sleep on exception handling minion connecting to
 the master (#307)

---
 salt/minion.py | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/salt/minion.py b/salt/minion.py
index 4730f68b87..e4bb116e17 100644
--- a/salt/minion.py
+++ b/salt/minion.py
@@ -1036,6 +1036,9 @@ class MinionManager(MinionBase):
         last = 0  # never have we signed in
         auth_wait = minion.opts['acceptance_wait_time']
         failed = False
+        retry_wait = 1
+        retry_wait_inc = 1
+        max_retry_wait = 20
         while True:
             try:
                 if minion.opts.get('beacons_before_connect', False):
@@ -1067,6 +1070,9 @@ class MinionManager(MinionBase):
                     'Unexpected error while connecting to %s',
                     minion.opts['master'], exc_info=True
                 )
+                yield salt.ext.tornado.gen.sleep(retry_wait)
+                if retry_wait < max_retry_wait:
+                    retry_wait += retry_wait_inc
 
     # Multi Master Tune In
     def tune_in(self):
-- 
2.30.0


